<?php

use Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException;
use Drupal\Component\Plugin\Exception\PluginNotFoundException;
use Drupal\Core\Entity\EntityStorageException;
use Drupal\Core\File\FileSystemInterface;
use Drupal\user\Entity\Role;

/**
 * Implements hook_install().
 * @throws EntityStorageException
 * @throws PluginNotFoundException
 * @throws InvalidPluginDefinitionException
 * @throws Exception
 */
function esn_membership_manager_install(): void
{
    /** @var FileSystemInterface $file_system */
    $file_system = Drupal::service('file_system');

    $directory = DRUPAL_ROOT . '/../../private/esn_membership_manager_storage';

    if (!$file_system->prepareDirectory($directory, FileSystemInterface::CREATE_DIRECTORY | FileSystemInterface::MODIFY_PERMISSIONS)) {
        Drupal::logger('esn_membership_manager')->error('Failed to create or prepare directory: @dir', ['@dir' => $directory]);
        return;
    }

    $htaccess_path = $directory . '/.htaccess';
    if (!file_exists($htaccess_path)) {
        $content = "Order deny,allow\nDeny from all\n";
        $content .= "<IfModule mod_authz_core.c>\n  Require all denied\n</IfModule>\n";
        file_put_contents($htaccess_path, $content);
    }

    $role_id = 'esn_membership_manager_admin';
    $role = Role::load($role_id);

    if (!$role) {
        $role = Role::create([
            'id' => $role_id,
            'label' => 'ESN Membership Manager Administrator',
        ]);
        $role->save();
    }

    if (empty($role->id())) {
        throw new Exception('Failed to create Role, aborting install to prevent corruption.');
    }

    $permissions = Drupal::service('user.permissions')->getPermissions();
    $module_permissions = [];

    foreach ($permissions as $perm_name => $perm_def) {
        if (isset($perm_def['provider']) && $perm_def['provider'] === 'esn_membership_manager') {
            $module_permissions[] = $perm_name;
        }
    }

    if (!empty($module_permissions)) {
        user_role_grant_permissions($role_id, $module_permissions);
    }

    $scope_storage = Drupal::entityTypeManager()->getStorage('oauth2_scope');
    $scope_name = 'esn_scanner';
    $scope = $scope_storage->load($scope_name);

    if (!$scope) {
        $scope_storage->create([
            'name' => $scope_name,
            'description' => 'Grants permissions for the ESN Membership Scanner App',
            'granularity_id' => 'role',
            'granularity_configuration' => [
                'role' => $role_id
            ],
            'grant_types' => [
                'authorization_code' => ['status' => TRUE, 'description' => ''],
                'refresh_token' => ['status' => TRUE, 'description' => ''],
            ]
        ])->save();
    }

    $consumer_storage = Drupal::entityTypeManager()->getStorage('consumer');
    $client_uuid = '45534e20-5363-616e-6572-204f41757468';

    $exists = $consumer_storage->loadByProperties(['uuid' => $client_uuid]);
    if (empty($exists)) {
        $consumer = $consumer_storage->create([
            'uuid' => $client_uuid,
            'label' => 'ESN Scanner App',
            'machine_name' => 'esn_scanner_app',
            'description' => 'Authentication client for the ESN Scanner app.',
            'client_id' => $client_uuid,
            'secret' => '',
            'confidential' => FALSE,
            'third_party' => FALSE,
            'pkce' => TRUE,
            'redirect' => 'org.esncy.esnscanner://callback',
            'grant_types' => [
                'authorization_code',
                'refresh_token',
            ],
        ]);
        $consumer->save();
    }
}

/**
 * Implements hook_schema().
 */
function esn_membership_manager_schema(): array
{
    $schema['esn_membership_manager_cards'] = [
        'description' => 'Stores ESNcard numbers for distribution.',
        'fields' => [
            'id' => [
                'description' => 'Primary Key: Unique ESNcard ID.',
                'type' => 'serial',
                'unsigned' => TRUE,
                'not null' => TRUE,
            ],
            'number' => [
                'description' => 'The ESNcard number.',
                'type' => 'varchar',
                'length' => 20,
                'not null' => TRUE,
            ],
            'assigned' => [
                'description' => 'Indicates whether the card is assigned or not.',
                'type' => 'int',
                'size' => 'tiny',
                'not null' => TRUE,
                'default' => 0,
            ]
        ],
        'primary key' => ['id'],
        'unique keys' => [
            'number' => ['number'],
        ],
    ];

    $schema['esn_membership_manager_applications'] = [
        'description' => 'Stores ESN Pass and ESNcard applications.',
        'fields' => [
            'id' => [
                'description' => 'Primary Key: Unique submission ID.',
                'type' => 'serial',
                'unsigned' => TRUE,
                'not null' => TRUE,
            ],
            'name' => [
                'description' => 'First Name.',
                'type' => 'varchar',
                'length' => 255,
                'not null' => TRUE,
            ],
            'surname' => [
                'description' => 'Surname.',
                'type' => 'varchar',
                'length' => 255,
                'not null' => TRUE,
            ],
            'email' => [
                'description' => 'User Email.',
                'type' => 'varchar',
                'length' => 255,
                'not null' => TRUE,
            ],
            'nationality' => [
                'description' => 'Nationality.',
                'type' => 'varchar',
                'length' => 128,
                'not null' => TRUE,
            ],
            'dob' => [
                'description' => 'Date of Birth.',
                'type' => 'varchar',
                'length' => 20,
                'not null' => TRUE,
            ],
            'mobility_status' => [
                'description' => 'The selected mobility status.',
                'type' => 'varchar',
                'length' => 128,
                'not null' => TRUE,
            ],
            'host_institution' => [
                'description' => 'Host University or Organization.',
                'type' => 'varchar',
                'length' => 255,
                'not null' => TRUE,
            ],
            'proof_fid' => [
                'description' => 'File ID for Proof of Status.',
                'type' => 'int',
                'unsigned' => TRUE,
            ],
            'id_document_fid' => [
                'description' => 'File ID for ID Document Scan.',
                'type' => 'int',
                'unsigned' => TRUE,
            ],
            'face_photo_fid' => [
                'description' => 'File ID for Passport Style Photo.',
                'type' => 'int',
                'unsigned' => TRUE,
            ],
            'pass' => [
                'description' => 'Was ESN Pass selected.',
                'type' => 'int',
                'size' => 'tiny',
                'not null' => TRUE,
                'default' => 0,
            ],
            'esncard' => [
                'description' => 'Was ESNcard selected.',
                'type' => 'int',
                'size' => 'tiny',
                'not null' => TRUE,
                'default' => 0,
            ],
            'pass_token' => [
                'description' => 'Unique user token for QR code.',
                'type' => 'varchar',
                'length' => 64,
            ],
            'esncard_number' => [
                'description' => 'ESNcard number.',
                'type' => 'varchar',
                'length' => 64,
            ],
            'payment_link' => [
                'description' => 'Stripe Payment link.',
                'type' => 'varchar',
                'length' => 255,
            ],
            'payment_link_id' => [
                'description' => 'Stripe Payment link ID.',
                'type' => 'varchar',
                'length' => 255,
            ],
            'approval_status' => [
                'description' => 'Current status (Pending, Paid, etc).',
                'type' => 'varchar',
                'length' => 32,
                'default' => 'Pending',
                'not null' => TRUE,
            ],
            'date_created' => [
                'description' => 'Timestamp when the submission was created.',
                'type' => 'varchar',
                'length' => 64,
                'not null' => TRUE,
            ],
            'date_approved' => [
                'description' => 'Timestamp when the submission was approved.',
                'type' => 'varchar',
                'length' => 64,
            ],
            'date_paid' => [
                'description' => 'Timestamp when payment was submitted.',
                'type' => 'varchar',
                'length' => 64,
            ],
            'date_last_scanned' => [
                'description' => 'Timestamp when the last scan was performed.',
                'type' => 'varchar',
                'length' => 64,
            ],
        ],
        'primary key' => ['id'],
        'unique keys' => [
            'pass_token' => ['pass_token'],
            'esncard_number' => ['esncard_number'],
        ],
        'indexes' => [
            'email' => ['email'],
            'approval_status' => ['approval_status']
        ],
    ];

    return $schema;
}