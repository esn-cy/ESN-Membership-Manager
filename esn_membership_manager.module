<?php /** @noinspection PhpUnused */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_webform_element_alter().
 */
function esn_membership_manager_webform_element_alter(array &$element, FormStateInterface $form_state, array $context): void
{
    $logger = Drupal::service('logger.factory')->get('esn_membership_manager');
    $database = Drupal::database();
    $moduleConfig = Drupal::config('esn_membership_manager.settings');

    static $available_esncards_count = NULL;

    $webform_id = $element['#webform_id'] ?? NULL;
    $element_key = $element['#webform_key'] ?? NULL;

    if ($webform_id && str_starts_with($webform_id, $moduleConfig->get('webform_id')) && $element_key === 'choices') {
        if ($available_esncards_count === NULL) {
            $query = $database->select('esncard_numbers', 'e');
            $query->condition('assigned', 0);
            $available_esncards_count = (int)$query->countQuery()->execute()->fetchField();

            $logger->notice('Available ESNcards count: @count', [
                '@count' => $available_esncards_count,
            ]);
        }
        $logger->notice('Available ESNcards count: @count', ['@count' => $available_esncards_count]);

        if ($available_esncards_count === 0) {
            // Disable the ESNcard option directly in options__properties
            if (!isset($element['#options__properties'])) {
                $element['#options__properties'] = [];
            }
            $element['#options__properties']['ESNcard']['#disabled'] = TRUE;

            // Add a small warning message
            if (!isset($element['#description'])) {
                $element['#description'] = '';
            }
            $element['#description'] .= '<div class="esncard-unavailable" style="color:red; font-size:0.9em; margin-top:4px;">No more ESNcards available at the moment</div>';

            $logger->notice('ESNcard option disabled successfully.');
        }
    }
}

/**
 * Implements hook_preprocess_menu().
 *
 * This hook is used to remove parent menu items that have no visible children
 * after access checks have been performed.
 */
function esn_membership_manager_preprocess_menu(&$variables): void
{
    if (isset($variables['menu_name']) && $variables['menu_name'] == 'main') {
        if (isset($variables['items'])) {
            _esn_membership_manager_menu_hide_empty_parents($variables['items']);
        }
    }
}

/**
 * A recursive helper function to traverse the menu tree.
 *
 * @param array $items
 * The menu items array, passed by reference.
 */
function _esn_membership_manager_menu_hide_empty_parents(array &$items): void
{
    foreach ($items as $key => &$item) {
        if (!empty($item['below'])) {
            _esn_membership_manager_menu_hide_empty_parents($item['below']);
        }

        $is_non_linking_parent = FALSE;
        if ($item['url']->isRouted()) {
            $routeName = $item['url']->getRouteName();
            $is_non_linking_parent = $routeName === '<nolink>' || $routeName === '<none>';
        }

        if ($is_non_linking_parent && empty($item['below'])) {
            unset($items[$key]);
        }
    }
}