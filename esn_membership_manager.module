<?php /** @noinspection PhpUnused */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Markup;

/**
 * Implements hook_webform_element_alter().
 */
function esn_membership_manager_webform_element_alter(array &$element, FormStateInterface $form_state, array $context): void
{
    $logger = Drupal::service('logger.factory')->get('esn_membership_manager');
    $database = Drupal::database();
    $moduleConfig = Drupal::config('esn_membership_manager.settings');

    static $available_esncards_count = NULL;

    $webform_id = $element['#webform_id'] ?? NULL;
    $element_key = $element['#webform_key'] ?? NULL;

    if ($webform_id && str_starts_with($webform_id, $moduleConfig->get('webform_id')) && $element_key === 'choices') {
        if ($available_esncards_count === NULL) {
            $query = $database->select('esn_membership_manager_cards', 'e');
            $query->condition('assigned', 0);
            $available_esncards_count = (int)$query->countQuery()->execute()->fetchField();

            $logger->notice('Available ESNcards count: @count', [
                '@count' => $available_esncards_count,
            ]);
        }
        $logger->notice('Available ESNcards count: @count', ['@count' => $available_esncards_count]);

        if ($available_esncards_count === 0) {
            // Disable the ESNcard option directly in options__properties
            if (!isset($element['#options__properties'])) {
                $element['#options__properties'] = [];
            }
            $element['#options__properties']['ESNcard']['#disabled'] = TRUE;

            // Add a small warning message
            if (!isset($element['#description'])) {
                $element['#description'] = '';
            }
            $element['#description'] .= '<div class="esncard-unavailable" style="color:red; font-size:0.9em; margin-top:4px;">No more ESNcards available at the moment</div>';

            $logger->notice('ESNcard option disabled successfully.');
        }
    }
}

/**
 * Implements hook_preprocess_menu().
 *
 * This hook is used to remove parent menu items that have no visible children
 * after access checks have been performed.
 */
function esn_membership_manager_preprocess_menu(&$variables): void
{
    if (isset($variables['menu_name']) && $variables['menu_name'] == 'main') {
        if (isset($variables['items'])) {
            _esn_membership_manager_menu_hide_empty_parents($variables['items']);
        }
    }
}

/**
 * A recursive helper function to traverse the menu tree.
 *
 * @param array $items
 * The menu items array, passed by reference.
 */
function _esn_membership_manager_menu_hide_empty_parents(array &$items): void
{
    foreach ($items as $key => &$item) {
        if (!empty($item['below'])) {
            _esn_membership_manager_menu_hide_empty_parents($item['below']);
        }

        $is_non_linking_parent = FALSE;
        if ($item['url']->isRouted()) {
            $routeName = $item['url']->getRouteName();
            $is_non_linking_parent = $routeName === '<nolink>' || $routeName === '<none>';
        }

        if ($is_non_linking_parent && empty($item['below'])) {
            unset($items[$key]);
        }
    }
}

/**
 * Implements hook_theme().
 * Registers the Twig email templates.
 */
function esn_membership_manager_theme($existing, $type, $theme, $path): array
{
    $common_vars = [
        'name' => 'Student',
        'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
        'custom_footer' => '',
        'scheme_name' => 'ESN Pass',
    ];

    return [
        // 1. Pass Approval (QR Code only)
        'emm_pass_approval' => [
            'variables' => array_merge($common_vars, [
                'user_token' => '',
                'google_wallet_link' => ''
            ])
        ],

        // 2. Both Approval (Pass + ESNcard)
        'emm_both_approval' => [
            'variables' => array_merge($common_vars, [
                'user_token' => '',
                'payment_link' => '',
                'google_wallet_link' => ''
            ]),
        ],

        // 3. ESNcard Assignment (Card issued/Created)
        'emm_card_assignment' => [
            'variables' => [
                'name' => 'Student',
                'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
                'custom_footer' => '',
                'esncard_number' => NULL,
                'google_wallet_link' => ''
            ],
        ],

        // 4. ESNcard Approval (Payment request)
        'emm_card_approval' => [
            'variables' => [
                'name' => 'Student',
                'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
                'custom_footer' => '',
                'payment_link' => NULL,
            ],
        ],

        // 5. Denial (Both)
        'emm_both_denial' => [
            'variables' => $common_vars,
        ],
    ];
}

/**
 * Implements hook_mail().
 */
function esn_membership_manager_mail($key, &$message, $params): void
{
    $config = Drupal::config('esn_membership_manager.settings');
    $from_email = $config->get('email_from_address');
    $from_name = $config->get('email_from_name');

    if ($from_email) {
        if ($from_name) {
            $message['from'] = "$from_name <$from_email>";
            $message['headers']['From'] = "$from_name <$from_email>";
        } else {
            $message['from'] = $from_email;
            $message['headers']['From'] = $from_email;
        }
    }

    $options = [
        'langcode' => $message['langcode'],
    ];

    $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
    $message['headers']['MIME-Version'] = '1.0';

    $scheme = $params['scheme_name'] ?? 'ESN Pass';

    switch ($key) {
        case 'pass_approval':
            $message['subject'] = t('@scheme Approval', ['@scheme' => $scheme], $options);
            break;

        case 'both_approval':
            $message['subject'] = t('@scheme and ESNcard Approval', ['@scheme' => $scheme], $options);
            break;

        case 'card_approval':
            $message['subject'] = t('ESNcard Application Approved', [], $options);
            break;

        case 'card_assignment':
            $message['subject'] = t('Your ESNcard Details', [], $options);
            break;

        case 'both_denial':
            $message['subject'] = t('Application Declined', [], $options);
            break;
    }

    if (isset($params['body'])) {
        $message['body'][] = Markup::create($params['body']);
    }
}