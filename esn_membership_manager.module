<?php /** @noinspection PhpUnused */

use Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException;
use Drupal\Component\Plugin\Exception\PluginNotFoundException;
use Drupal\Core\Datetime\DrupalDateTime;
use Drupal\Core\Entity\EntityStorageException;
use Drupal\Core\Render\Markup;
use Drupal\Core\StreamWrapper\StreamWrapperManager;
use Drupal\user\Entity\User;

/**
 * Implements hook_theme().
 * Registers the Twig email templates.
 */
function esn_membership_manager_theme($existing, $type, $theme, $path): array
{
    $common_vars = [
        'name' => 'Student',
        'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
        'custom_footer' => '',
        'scheme_name' => 'ESN Pass',
    ];

    return [
        // 1. Pass Approval (QR Code only)
        'emm_pass_approval' => [
            'variables' => array_merge($common_vars, [
                'user_token' => '',
                'google_wallet_link' => ''
            ])
        ],

        // 2. Both Approval (Pass + ESNcard)
        'emm_both_approval' => [
            'variables' => array_merge($common_vars, [
                'user_token' => '',
                'payment_link' => '',
                'google_wallet_link' => ''
            ]),
        ],

        // 3. ESNcard Assignment (Card issued/Created)
        'emm_card_assignment' => [
            'variables' => [
                'name' => 'Student',
                'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
                'custom_footer' => '',
                'esncard_number' => NULL,
                'google_wallet_link' => ''
            ],
        ],

        // 4. ESNcard Approval (Payment request)
        'emm_card_approval' => [
            'variables' => [
                'name' => 'Student',
                'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
                'custom_footer' => '',
                'payment_link' => NULL,
            ],
        ],

        // 5. Denial (Both)
        'emm_both_denial' => [
            'variables' => $common_vars,
        ],

        // 6. Pass Confirmation
        'emm_pass_confirmation' => [
            'variables' => $common_vars,
        ],

        // 7. Card Confirmation
        'emm_card_confirmation' => [
            'variables' => $common_vars,
        ],

        // 8. Both Confirmation
        'emm_both_confirmation' => [
            'variables' => $common_vars,
        ],

        // 9. Pass Blacklist
        'emm_pass_blacklist' => [
            'variables' => $common_vars,
        ],

        // 10. Card Issuance
        'emm_card_issuance' => [
            'variables' => $common_vars,
        ],

        'emm_submission_view' => [
            'variables' => [
                'id' => NULL,
                'fieldData' => [],
                'urls' => [],
                'permissions' => [],
                'apiURLs' => [],
            ],
        ],
    ];
}

/**
 * Implements hook_mail().
 */
function esn_membership_manager_mail($key, &$message, $params): void
{
    $config = Drupal::config('esn_membership_manager.settings');
    $from_email = $config->get('email_from_address');
    $from_name = $config->get('email_from_name');

    if ($from_email) {
        if ($from_name) {
            $message['from'] = "$from_name <$from_email>";
            $message['headers']['From'] = "$from_name <$from_email>";
        } else {
            $message['from'] = $from_email;
            $message['headers']['From'] = $from_email;
        }
    }

    $options = [
        'langcode' => $message['langcode'],
    ];

    $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
    $message['headers']['MIME-Version'] = '1.0';

    $scheme = $params['scheme_name'] ?? 'ESN Pass';

    switch ($key) {
        case 'pass_approval':
            $message['subject'] = t('@scheme Approval', ['@scheme' => $scheme], $options);
            break;

        case 'both_approval':
            $message['subject'] = t('@scheme and ESNcard Approval', ['@scheme' => $scheme], $options);
            break;

        case 'card_approval':
            $message['subject'] = t('ESNcard Application Approved', [], $options);
            break;

        case 'card_assignment':
            $message['subject'] = t('Your ESNcard Details', [], $options);
            break;

        case 'both_denial':
            $message['subject'] = t('Application Declined', [], $options);
            break;

        case 'pass_confirmation':
            $message['subject'] = t('@scheme Application Received', ['@scheme' => $scheme], $options);
            break;

        case 'card_confirmation':
            $message['subject'] = t('ESNcard Application Received', [], $options);
            break;

        case 'both_confirmation':
            $message['subject'] = t('@scheme and ESNcard Application Received', ['@scheme' => $scheme], $options);
            break;

        case 'pass_blacklist':
            $message['subject'] = t('@scheme Blacklisted', [], $options);
            break;

        case 'card_issuance':
            $message['subject'] = t('ESNcard Issued', [], $options);
            break;
    }

    if (isset($params['body'])) {
        $message['body'][] = Markup::create($params['body']);
    }
}

/**
 * Implements hook_file_download().
 */
function esn_membership_manager_file_download($uri): array|int|null
{
    $scheme = StreamWrapperManager::getScheme($uri);

    if ($scheme === 'membership') {
        $currentUser = Drupal::currentUser();
        if ($currentUser->hasPermission('view submissions')) {
            return [
                'Content-Type' => Drupal::service('file.mime_type.guesser')->guessMimeType($uri),
                'Cache-Control' => 'private',
            ];
        }
        return -1;
    }
    return NULL;
}

/**
 * Implements hook_preprocess_page().
 */
function esn_membership_preprocess_page(&$variables): void
{
    $route_name = Drupal::routeMatch()->getRouteName();

    $routes_to_hide = [
        'esn_membership_manager.apply',
    ];

    if (in_array($route_name, $routes_to_hide)) {
        if (isset($variables['page']['breadcrumb'])) {
            unset($variables['page']['breadcrumb']);
        }
    }
}

/**
 * Implements hook_preprocess_menu().
 *
 * Flattens the menu structure for users who can only see the Apply link.
 */
function esn_membership_manager_preprocess_menu(&$variables): void
{
    if (isset($variables['items']['esn_membership_manager.category'])) {
        $category = $variables['items']['esn_membership_manager.category'];

        if (empty($category['below'])) {
            return;
        }
        if (count($category['below']) === 1 && isset($category['below']['esn_membership_manager.apply'])) {
            $variables['items']['esn_membership_manager.apply'] = $category['below']['esn_membership_manager.apply'];
            $variables['items']['esn_membership_manager.apply']['title'] = t('Membership Form');
            $variables['items']['esn_membership_manager.apply']['weight'] = -50;
            unset($variables['items']['esn_membership_manager.category']);
            uasort($variables['items'], ['\Drupal\Component\Utility\SortArray', 'sortByWeightElement']);
        }
    }
}

/**
 * Implements hook_cron().
 *
 * Handles GDPR Retention policies:
 * 1. Proofs & ID Scans: Deleted after 2 weeks (14 days).
 * 2. PII & Face Photos: Deleted after 1 year (365 days).
 */
function esn_membership_manager_cron(): void
{
    $database = Drupal::database();
    $logger = Drupal::service('logger.factory')->get('esn_membership_manager');

    $now = new DrupalDateTime();
    $twoWeeksAgo = $now->sub(new DateInterval('P14D'));
    $oneYearAgo = $now->sub(new DateInterval('P1Y'));
    $format = 'Y-m-d H:i:s';

    try {
        $fileStorage = Drupal::entityTypeManager()->getStorage('file');
    } catch (InvalidPluginDefinitionException|PluginNotFoundException $e) {
        $logger->error('Cron Error: File storage could not be loaded. @message', ['@message' => $e->getMessage()]);
        return;
    }

    // 1. Proofs & ID Scans: Deleted after 2 weeks
    // Based on approved date
    $query2W = $database->select('esn_membership_manager_applications', 'a')
        ->fields('a', ['id', 'proof_fid', 'id_document_fid'])
        ->condition('date_approved', $twoWeeksAgo->format($format), '<');

    // Only process if there are files to delete
    $filesExistCondition = $query2W->orConditionGroup()
        ->isNotNull('proof_fid')
        ->isNotNull('id_document_fid');
    $query2W->condition($filesExistCondition);

    // 2. PII & Face Photos: Deleted after 1 year relative to status
    $query1Y = $database->select('esn_membership_manager_applications', 'a')
        ->fields('a', ['id', 'face_photo_fid']);

    // Create the conditional retention logic group for 1 year
    $retentionCondition = $query1Y->orConditionGroup();

    // Condition A: ESNcard wanted (1) AND paid more than 1 year ago
    $conditionPaid1Y = $query1Y->andConditionGroup()
        ->condition('esncard', 1)
        ->condition('date_paid', $oneYearAgo->format($format), '<');

    // Condition B: ESNcard NOT wanted (0) AND approved more than 1 year ago
    $conditionApproved1Y = $query1Y->andConditionGroup()
        ->condition('esncard', 0)
        ->condition('date_approved', $oneYearAgo->format($format), '<');

    $retentionCondition->condition($conditionPaid1Y);
    $retentionCondition->condition($conditionApproved1Y);

    $query1Y->condition($retentionCondition);

    try {
        $results2W = $query2W->execute()->fetchAll();
        $results1Y = $query1Y->execute()->fetchAll();
    } catch (Exception $e) {
        $logger->error('Database Query Error: There was an issue fetching the applications. @message', ['@message' => $e->getMessage()]);
        return;
    }

    // Process 2-week deletions
    foreach ($results2W as $row) {
        $fidsToDelete = [];
        if ($row->proof_fid) $fidsToDelete['proof_fid'] = $row->proof_fid;
        if ($row->id_document_fid) $fidsToDelete['id_document_fid'] = $row->id_document_fid;

        if (!empty($fidsToDelete)) {
            foreach ($fidsToDelete as $fieldName => $fid) {
                // Delete the file entity
                $file = $fileStorage->load($fid);
                if ($file) {
                    try {
                        $file->delete();
                    } catch (EntityStorageException $e) {
                        $logger->warning('File Warning: Unable to delete file: @file. @message', [
                            '@file' => $fid,
                            '@message' => $e->getMessage()
                        ]);
                    }
                }

                try {
                    $database->update('esn_membership_manager_applications')
                        ->fields([
                            $fieldName => NULL,
                        ])
                        ->condition('id', $row->id)
                        ->execute();
                } catch (Exception $e) {
                    $logger->warning('Database Warning: Unable to nullify field @field for application @id. Message: @message', [
                        '@field' => $fieldName,
                        '@id' => $row->id,
                        '@message' => $e->getMessage()
                    ]);
                }
            }
        }
    }

    // Process 1-year deletions
    foreach ($results1Y as $row) {
        // Delete face photo if exists
        if ($row->face_photo_fid) {
            $file = $fileStorage->load($row->face_photo_fid);
            if ($file) {
                try {
                    $file->delete();
                } catch (EntityStorageException $e) {
                    $logger->warning('File Warning: Unable to delete file: @fid. Message: @message', [
                        '@fid' => $row->face_photo_fid,
                        '@message' => $e->getMessage()
                    ]);
                }
            }
        }

        // Anonymize the record
        try {
            $database->update('esn_membership_manager_applications')
                ->fields([
                    'name' => 'Anonymized',
                    'surname' => 'Anonymized',
                    'email' => 'Anonymized',
                    'dob' => '1970-01-01',
                    'face_photo_fid' => NULL,
                    'payment_link' => NULL,
                ])
                ->condition('id', $row->id)
                ->execute();
        } catch (Exception $e) {
            $logger->warning('Database Warning: Unable to delete application ID: @id. Message: @message', [
                '@id' => $row->id,
                '@message' => $e->getMessage()
            ]);
        }
    }
}

/**
 * Implements hook_simple_oauth_private_claims_alter().
 */
function esn_membership_manager_simple_oauth_private_claims_alter(&$private_claims, $token_entity): void
{
    $user_id = $token_entity->getUserIdentifier();
    if (!$user_id) {
        return;
    }

    $user = User::load($user_id);

    $permissions = Drupal::service('user.permissions')->getPermissions();
    $granted = [];
    foreach ($permissions as $machine_name => $definition) {
        if (isset($definition['provider']) && $definition['provider'] === 'esn_membership_manager') {
            if ($user->hasPermission($machine_name)) {
                $granted[] = $machine_name;
            }
        }
    }

    $private_claims['name'] = $user->getDisplayName();
    $private_claims['permissions'] = $granted;
}