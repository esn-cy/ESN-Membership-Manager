<?php /** @noinspection PhpUnused */

use Drupal\Core\Render\Markup;
use Drupal\Core\StreamWrapper\StreamWrapperManager;

/**
 * Implements hook_preprocess_menu().
 *
 * This hook is used to remove parent menu items that have no visible children
 * after access checks have been performed.
 */
function esn_membership_manager_preprocess_menu(&$variables): void
{
    if (isset($variables['menu_name']) && $variables['menu_name'] == 'main') {
        if (isset($variables['items'])) {
            _esn_membership_manager_menu_hide_empty_parents($variables['items']);
        }
    }
}

/**
 * A recursive helper function to traverse the menu tree.
 *
 * @param array $items
 * The menu items array, passed by reference.
 */
function _esn_membership_manager_menu_hide_empty_parents(array &$items): void
{
    foreach ($items as $key => &$item) {
        if (!empty($item['below'])) {
            _esn_membership_manager_menu_hide_empty_parents($item['below']);
        }

        $is_non_linking_parent = FALSE;
        if ($item['url']->isRouted()) {
            $routeName = $item['url']->getRouteName();
            $is_non_linking_parent = $routeName === '<nolink>' || $routeName === '<none>';
        }

        if ($is_non_linking_parent && empty($item['below'])) {
            unset($items[$key]);
        }
    }
}

/**
 * Implements hook_theme().
 * Registers the Twig email templates.
 */
function esn_membership_manager_theme($existing, $type, $theme, $path): array
{
    $common_vars = [
        'name' => 'Student',
        'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
        'custom_footer' => '',
        'scheme_name' => 'ESN Pass',
    ];

    return [
        // 1. Pass Approval (QR Code only)
        'emm_pass_approval' => [
            'variables' => array_merge($common_vars, [
                'user_token' => '',
                'google_wallet_link' => ''
            ])
        ],

        // 2. Both Approval (Pass + ESNcard)
        'emm_both_approval' => [
            'variables' => array_merge($common_vars, [
                'user_token' => '',
                'payment_link' => '',
                'google_wallet_link' => ''
            ]),
        ],

        // 3. ESNcard Assignment (Card issued/Created)
        'emm_card_assignment' => [
            'variables' => [
                'name' => 'Student',
                'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
                'custom_footer' => '',
                'esncard_number' => NULL,
                'google_wallet_link' => ''
            ],
        ],

        // 4. ESNcard Approval (Payment request)
        'emm_card_approval' => [
            'variables' => [
                'name' => 'Student',
                'logo_location' => 'https://esn.org/sites/default/files/ESN_full-logo-Satellite.png',
                'custom_footer' => '',
                'payment_link' => NULL,
            ],
        ],

        // 5. Denial (Both)
        'emm_both_denial' => [
            'variables' => $common_vars,
        ],

        // 6. Pass Confirmation
        'emm_pass_confirmation' => [
            'variables' => $common_vars,
        ],

        // 7. Card Confirmation
        'emm_card_confirmation' => [
            'variables' => $common_vars,
        ],

        // 8. Both Confirmation
        'emm_both_confirmation' => [
            'variables' => $common_vars,
        ],
    ];
}

/**
 * Implements hook_mail().
 */
function esn_membership_manager_mail($key, &$message, $params): void
{
    $config = Drupal::config('esn_membership_manager.settings');
    $from_email = $config->get('email_from_address');
    $from_name = $config->get('email_from_name');

    if ($from_email) {
        if ($from_name) {
            $message['from'] = "$from_name <$from_email>";
            $message['headers']['From'] = "$from_name <$from_email>";
        } else {
            $message['from'] = $from_email;
            $message['headers']['From'] = $from_email;
        }
    }

    $options = [
        'langcode' => $message['langcode'],
    ];

    $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
    $message['headers']['MIME-Version'] = '1.0';

    $scheme = $params['scheme_name'] ?? 'ESN Pass';

    switch ($key) {
        case 'pass_approval':
            $message['subject'] = t('@scheme Approval', ['@scheme' => $scheme], $options);
            break;

        case 'both_approval':
            $message['subject'] = t('@scheme and ESNcard Approval', ['@scheme' => $scheme], $options);
            break;

        case 'card_approval':
            $message['subject'] = t('ESNcard Application Approved', [], $options);
            break;

        case 'card_assignment':
            $message['subject'] = t('Your ESNcard Details', [], $options);
            break;

        case 'both_denial':
            $message['subject'] = t('Application Declined', [], $options);
            break;

        case 'pass_confirmation':
            $message['subject'] = t('@scheme Application Received', ['@scheme' => $scheme], $options);
            break;

        case 'card_confirmation':
            $message['subject'] = t('ESNcard Application Received', [], $options);
            break;

        case 'both_confirmation':
            $message['subject'] = t('@scheme and ESNcard Application Received', ['@scheme' => $scheme], $options);
            break;
    }

    if (isset($params['body'])) {
        $message['body'][] = Markup::create($params['body']);
    }
}

/**
 * Implements hook_file_download().
 */
function esn_membership_manager_file_download($uri): array|int|null
{
    $scheme = StreamWrapperManager::getScheme($uri);

    if ($scheme === 'membership') {
        $currentUser = Drupal::currentUser();
        if ($currentUser->hasPermission('view submissions')) {
            return [
                'Content-Type' => Drupal::service('file.mime_type.guesser')->guessMimeType($uri),
                'Cache-Control' => 'private',
            ];
        }
        return -1;
    }
    return NULL;
}

/**
 * Implements hook_preprocess_page().
 */
function esn_membership_preprocess_page(&$variables): void
{
    $route_name = Drupal::routeMatch()->getRouteName();

    $routes_to_hide = [
        'esn_membership_manager.apply',
    ];

    if (in_array($route_name, $routes_to_hide)) {
        if (isset($variables['page']['breadcrumb'])) {
            unset($variables['page']['breadcrumb']);
        }
    }
}